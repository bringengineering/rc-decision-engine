<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>염수분사 시뮬레이션 — 로드뷰 + 위성지도 + 3D</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e82f41c12b9d5d03182e9c5ffbeeb578&libraries=services"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e0e0;font-family:'Segoe UI',sans-serif;height:100vh;overflow:hidden}
.app{display:grid;grid-template-columns:290px 1fr 310px;grid-template-rows:50px 1fr;height:100vh}

.header{grid-column:1/-1;background:#111827;border-bottom:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between;padding:0 16px}
.header h1{font-size:13px;font-weight:600;color:#60a5fa}
.header-r{display:flex;align-items:center;gap:10px}
.tabs{display:flex;gap:2px;background:#1e293b;border-radius:6px;padding:2px}
.tab{padding:5px 14px;border-radius:4px;border:none;background:transparent;color:#94a3b8;font-size:11px;cursor:pointer;font-weight:600;transition:all .15s}
.tab.on{background:#2563eb;color:#fff}
.tab:hover:not(.on){background:#334155}
.badge{padding:3px 10px;border-radius:10px;font-size:9px;font-weight:700;letter-spacing:.5px}
.b-place{background:#1e40af;color:#93c5fd}
.b-sim{background:#065f46;color:#6ee7b7}

.pl{background:#111827;border-right:1px solid #1e293b;padding:10px;overflow-y:auto;font-size:11px}
.st{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:#60a5fa;margin:10px 0 5px;padding-bottom:3px;border-bottom:1px solid #1e293b}
.st:first-child{margin-top:0}
.lb{display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;margin-top:4px}
.lb .lv{color:#60a5fa;font-weight:600}
input[type="range"]{width:100%;accent-color:#60a5fa;margin-bottom:1px}
select.sc{width:100%;background:#1e293b;color:#e0e0e0;border:1px solid #334155;padding:4px 7px;border-radius:4px;font-size:11px;margin-top:3px}
.bt{padding:5px 12px;border-radius:4px;border:1px solid #334155;background:#1e293b;color:#e0e0e0;font-size:11px;cursor:pointer;transition:all .15s}
.bt:hover{background:#334155}
.bt-p{background:#2563eb;border-color:#3b82f6;color:#fff}
.bt-p:hover{background:#1d4ed8}
.bt-d{background:#991b1b;border-color:#dc2626;color:#fca5a5}
.brow{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
.ib{background:#0f172a;border:1px solid #1e293b;border-radius:5px;padding:7px;font-size:10px;color:#94a3b8;line-height:1.6;margin-top:5px}
.ib strong{color:#60a5fa}
.di{background:#1e293b;border:1px solid #334155;border-radius:4px;padding:5px 7px;margin-bottom:4px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.di .dn{color:#fbbf24;font-weight:600}
.di .dc{color:#64748b;font-size:9px}
.di .dx{color:#ef4444;cursor:pointer;padding:1px 4px;border-radius:3px}
.di .dx:hover{background:#450a0a}

.center{position:relative}
#mapPanel,#rvPanel,#v3d{position:absolute;top:0;left:0;width:100%;height:100%}
#v3d{display:none}
#rvPanel{display:none;z-index:2}
#mapPanel{z-index:1}
#leafletMap{width:100%;height:100%}
#kakaoRoadview{width:100%;height:100%}
#v3d canvas{width:100%!important;height:100%!important}
.crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100;pointer-events:none;color:#fff;font-size:22px;text-shadow:0 0 4px #000;display:none}
.hud{position:absolute;bottom:10px;left:10px;z-index:100;background:rgba(17,24,39,.88);padding:7px 12px;border-radius:6px;font-size:10px;border:1px solid #1e293b;display:none;line-height:1.6}
.hud .ht{color:#60a5fa;font-weight:600;margin-bottom:2px}
.mtip{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(17,24,39,.9);padding:4px 12px;border-radius:14px;font-size:11px;color:#94a3b8;border:1px solid #334155;pointer-events:none}
.mtip span{color:#60a5fa;font-weight:600}

/* 로드뷰 오버레이 */
.rv-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}
.rv-device-marker{position:absolute;pointer-events:none;text-align:center}
.rv-device-marker .rv-icon{width:40px;height:40px;background:radial-gradient(circle,#fbbf24 30%,rgba(251,191,36,0.3) 70%);border-radius:50%;margin:0 auto;border:2px solid #f59e0b;animation:rvpulse 2s infinite}
.rv-device-marker .rv-label{background:rgba(17,24,39,.85);color:#fbbf24;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;margin-top:4px;display:inline-block;border:1px solid #f59e0b}
.rv-spray-effect{position:absolute;bottom:0;left:0;width:100%;height:40%;pointer-events:none;background:linear-gradient(0deg,rgba(59,130,246,0.15) 0%,transparent 100%);z-index:5}
.rv-info{position:absolute;top:10px;right:10px;z-index:20;background:rgba(17,24,39,.9);padding:10px;border-radius:6px;font-size:11px;border:1px solid #1e293b;pointer-events:auto;min-width:180px}
.rv-info .rit{color:#60a5fa;font-weight:600;margin-bottom:4px}
@keyframes rvpulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.6}}

.pr{background:#111827;border-left:1px solid #1e293b;padding:10px;overflow-y:auto}
.vb{text-align:center;padding:10px;border-radius:7px;margin-bottom:10px;font-size:18px;font-weight:800;letter-spacing:2px}
.v-F{background:#450a0a;color:#f87171;border:2px solid #dc2626}
.v-P{background:#052e16;color:#4ade80;border:2px solid #16a34a}
.v-C{background:#422006;color:#fbbf24;border:2px solid #d97706}
.v-R{background:#1e293b;color:#64748b;border:2px solid #334155}
.sr{display:flex;justify-content:space-between;padding:4px 0;font-size:10px;border-bottom:1px solid #1e293b}
.sr .sl{color:#94a3b8}.sr .sv{font-weight:600}
.crit{color:#f87171}.warn{color:#fbbf24}.good{color:#4ade80}
.fi{border-left:3px solid #dc2626;padding:5px 7px;margin-bottom:4px;border-radius:0 4px 4px 0;font-size:10px;background:#1e1215}
.fi.fw{border-left-color:#d97706;background:#1e1a0f}
.fi .ft{font-weight:600;color:#f87171}.fi.fw .ft{color:#fbbf24}
.fi .fd{color:#94a3b8;margin-top:2px}
.rb{background:#1e293b;border-radius:4px;height:16px;overflow:hidden;margin-top:3px}
.rb-in{height:100%;background:linear-gradient(90deg,#dc2626,#f87171);transition:width .4s;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;color:#fff}
.disc{font-size:8px;color:#4b5563;line-height:1.4;margin-top:8px}

.sbox{position:relative;margin-bottom:5px}
.sbox input{width:100%;background:#1e293b;border:1px solid #334155;color:#e0e0e0;padding:5px 7px;border-radius:4px;font-size:11px}
.sbox input::placeholder{color:#4b5563}
.sres{position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid #334155;border-radius:0 0 4px 4px;max-height:160px;overflow-y:auto;z-index:100;display:none}
.sres .si{padding:5px 7px;font-size:10px;cursor:pointer;border-bottom:1px solid #111827}
.sres .si:hover{background:#334155}
.leaflet-container{background:#0f172a}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Brine Spray Simulation</h1>
    <div class="header-r">
      <div class="tabs">
        <button class="tab on" id="tMap" onclick="switchTab('map')">Satellite</button>
        <button class="tab" id="tRv" onclick="switchTab('rv')">Road View</button>
        <button class="tab" id="t3d" onclick="switchTab('3d')">3D Walk</button>
      </div>
      <div class="badge b-place" id="badge">PLACEMENT</div>
    </div>
  </div>

  <!-- LEFT -->
  <div class="pl">
    <div class="st">Location</div>
    <div class="sbox">
      <input type="text" id="sIn" placeholder="Search (대관령, 강남역...)">
      <div class="sres" id="sRes"></div>
    </div>
    <select class="sc" id="qLoc">
      <option value="">-- Quick Locations --</option>
      <option value="37.6879,128.7597">Daegwallyeong (대관령)</option>
      <option value="37.5665,126.9780">Seoul City Hall</option>
      <option value="37.3943,127.1103">Pangyo IC (판교)</option>
      <option value="35.1796,129.0756">Busan Gwangan Bridge</option>
      <option value="37.8813,127.7298">Chuncheon (춘천)</option>
      <option value="36.3504,127.3845">Daejeon IC</option>
    </select>

    <div class="st">Instructions</div>
    <div class="ib">
      <strong>Satellite:</strong> Click to place devices<br>
      <strong>Road View:</strong> Real street view + overlay<br>
      <strong>3D Walk:</strong> WASD move, mouse look<br>
      <strong>Run Simulation</strong> for judgment
    </div>

    <div class="st">Device Settings</div>
    <label class="lb">Spray Range <span class="lv" id="vR">8.0m</span></label>
    <input type="range" id="sR" min="2" max="25" value="8" step="0.5">
    <label class="lb">Spray Angle <span class="lv" id="vA">120°</span></label>
    <input type="range" id="sA" min="30" max="360" value="120" step="10">
    <label class="lb">Burial Depth <span class="lv" id="vB">400mm</span></label>
    <input type="range" id="sB" min="0" max="1200" value="400" step="50">
    <label class="lb">Flow Rate <span class="lv" id="vF">5.0 L/min</span></label>
    <input type="range" id="sF" min="1" max="20" value="5" step="0.5">

    <div class="st">Environment</div>
    <select class="sc" id="envP">
      <option value="gangwon_night">Gangwon Night (-15°C, Snow)</option>
      <option value="seoul_night">Seoul Night (-8°C, Snow)</option>
      <option value="busan_morning">Busan Morning (-2°C, Rain)</option>
      <option value="mild">Mild (-3°C)</option>
    </select>
    <label class="lb">Wind <span class="lv" id="vW">5.0 m/s</span></label>
    <input type="range" id="sW" min="0" max="15" value="5" step="0.5">

    <div class="st">Devices (<span id="dcnt">0</span>)</div>
    <div id="dlist"></div>
    <div class="brow">
      <button class="bt bt-p" onclick="runSim()">Run Simulation</button>
      <button class="bt bt-d" onclick="clearAll()">Clear All</button>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div id="mapPanel">
      <div class="mtip" id="mapTip">Click to <span>place devices</span></div>
      <div id="leafletMap"></div>
    </div>
    <div id="rvPanel">
      <div id="kakaoRoadview"></div>
      <div class="rv-overlay" id="rvOverlay">
        <div class="rv-spray-effect" id="rvSpray" style="display:none"></div>
      </div>
      <div class="rv-info" id="rvInfo" style="display:none">
        <div class="rit">Road View — Device Overlay</div>
        <div id="rvInfoContent"></div>
      </div>
    </div>
    <div id="v3d">
      <div class="crosshair" id="cross">+</div>
      <div class="hud" id="hud3d">
        <div class="ht">3D Walk</div>
        <div>WASD: Move / Mouse: Look</div>
        <div id="hudP"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="pr">
    <div class="st">Judgment</div>
    <div class="vb v-R" id="vb">READY</div>
    <div class="st">Statistics</div>
    <div id="stats"><div class="sr"><span class="sl">Place devices first</span></div></div>
    <div class="st">Ice Risk</div>
    <div class="rb"><div class="rb-in" id="iceB" style="width:0%">0%</div></div>
    <div class="st" style="margin-top:8px">Failures</div>
    <div id="fails"><div style="font-size:10px;color:#4b5563">No simulation yet</div></div>
    <div class="disc">
      This system provides JUDGMENT INFORMATION only.
      All DECISIONS remain with qualified engineers. L0 rule-based.
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════
// STATE
// ═══════════════════════════════
let devices=[],leafMarkers=[],overlays=[],devN=0,simOn=false,curTab='map';
let mapCenter={lat:37.6879,lng:128.7597};

const ENVS={
  gangwon_night:{temp:-15,wind:5,wdir:270,hum:75,prec:'snow',cloud:95},
  seoul_night:{temp:-8,wind:3.5,wdir:315,hum:65,prec:'snow',cloud:90},
  busan_morning:{temp:-2,wind:6,wdir:180,hum:80,prec:'freezing_rain',cloud:80},
  mild:{temp:-3,wind:2,wdir:90,hum:55,prec:'snow',cloud:60},
};
const FROST={gangwon:900,seoul:600,busan:300,default:600};

// ═══════════════════════════════
// LEAFLET MAP
// ═══════════════════════════════
const lmap=L.map('leafletMap',{center:[37.6879,128.7597],zoom:17});
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}).addTo(lmap);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,opacity:.6}).addTo(lmap);

lmap.on('click',e=>{addDevice(e.latlng.lat,e.latlng.lng);});

function addDevice(lat,lng){
  devN++;
  const id='SPR-'+String(devN).padStart(3,'0');
  const s=getSet();
  const d={id,lat,lng,...s};
  devices.push(d);
  const mk=L.marker([lat,lng],{icon:L.divIcon({className:'',html:`<svg width="26" height="26"><circle cx="13" cy="13" r="8" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/><circle cx="13" cy="13" r="3" fill="#111"/></svg>`,iconSize:[26,26],iconAnchor:[13,13]}),draggable:true}).addTo(lmap);
  mk.bindTooltip(id,{permanent:false,direction:'top',offset:[0,-13]});
  mk.on('dragend',ev=>{const p=ev.target.getLatLng();d.lat=p.lat;d.lng=p.lng;if(simOn)runSim();});
  leafMarkers.push(mk);
  updList();
}

// ═══════════════════════════════
// KAKAO ROADVIEW
// ═══════════════════════════════
let rvObj=null, rvClient=null;

function initRoadview(){
  if(rvObj)return;
  const container=document.getElementById('kakaoRoadview');
  rvObj=new kakao.maps.Roadview(container);
  rvClient=new kakao.maps.RoadviewClient();
}

function showRoadview(lat,lng){
  initRoadview();
  const pos=new kakao.maps.LatLng(lat,lng);
  rvClient.getNearestPanoId(pos,100,function(panoid){
    if(panoid===null){
      document.getElementById('rvInfoContent').innerHTML='<span style="color:#f87171">No road view available at this location</span>';
      document.getElementById('rvInfo').style.display='block';
      return;
    }
    rvObj.setPanoId(panoid,pos);
    updateRvOverlay();
  });
}

function updateRvOverlay(){
  if(!devices.length){
    document.getElementById('rvSpray').style.display='none';
    document.getElementById('rvInfo').style.display='none';
    return;
  }

  // 로드뷰에 장치 정보 오버레이
  const s=getSet();
  const env=getEnv();
  let tE=1;if(env.temp<-10)tE=.7;else if(env.temp<-5)tE=.85;else if(env.temp<0)tE=.95;
  const eR=s.range*tE;

  // 분사 효과 표시
  if(simOn){
    document.getElementById('rvSpray').style.display='block';
  }

  // 정보 패널
  document.getElementById('rvInfo').style.display='block';
  document.getElementById('rvInfoContent').innerHTML=`
    <div style="margin-top:4px;font-size:10px;line-height:1.6">
      <div>Devices: <strong style="color:#fbbf24">${devices.length}</strong></div>
      <div>Eff Range: <strong>${eR.toFixed(1)}m</strong></div>
      <div>Temperature: <strong>${env.temp}°C</strong></div>
      <div>Wind: <strong>${env.wind} m/s</strong></div>
      <div>Burial: <strong>${s.burial}mm</strong></div>
      ${simOn?`<div style="margin-top:4px;padding:4px;background:#1e40af44;border-radius:4px;text-align:center">
        <strong style="color:#60a5fa">SIMULATION ACTIVE</strong><br>
        <span style="font-size:9px">Blue tint = spray coverage area</span>
      </div>`:''}
    </div>
  `;

  // 장치 마커를 로드뷰에 오버레이 (CSS 마커)
  const overlay=document.getElementById('rvOverlay');
  // 기존 마커 제거
  overlay.querySelectorAll('.rv-device-marker').forEach(e=>e.remove());

  // 간단한 시각적 마커 배치 (화면 분할)
  const count=devices.length;
  devices.forEach((d,i)=>{
    const marker=document.createElement('div');
    marker.className='rv-device-marker';
    const leftPct=15+((i/(Math.max(count-1,1)))*70);
    marker.style.left=leftPct+'%';
    marker.style.bottom='20%';
    marker.innerHTML=`
      <div class="rv-icon"></div>
      <div class="rv-label">${d.id}</div>
    `;
    overlay.appendChild(marker);
  });
}

// ═══════════════════════════════
// TAB SWITCH
// ═══════════════════════════════
function switchTab(t){
  curTab=t;
  document.getElementById('tMap').classList.toggle('on',t==='map');
  document.getElementById('tRv').classList.toggle('on',t==='rv');
  document.getElementById('t3d').classList.toggle('on',t==='3d');
  document.getElementById('mapPanel').style.display=t==='map'?'block':'none';
  document.getElementById('rvPanel').style.display=t==='rv'?'block':'none';
  document.getElementById('v3d').style.display=t==='3d'?'block':'none';
  document.getElementById('cross').style.display=t==='3d'?'block':'none';
  document.getElementById('hud3d').style.display=t==='3d'?'block':'none';
  document.getElementById('mapTip').style.display=t==='map'?'block':'none';

  if(t==='rv'){
    const c=lmap.getCenter();
    showRoadview(c.lat,c.lng);
  }
  if(t==='3d')start3D();
}

// ═══════════════════════════════
// HELPERS
// ═══════════════════════════════
function getSet(){return{range:+$('sR').value,angle:+$('sA').value,burial:+$('sB').value,flow:+$('sF').value};}
function getEnv(){const k=$('envP').value;const e={...ENVS[k]};e.wind=+$('sW').value;return e;}
function $(id){return document.getElementById(id);}
function removeDevice(i){devices.splice(i,1);lmap.removeLayer(leafMarkers[i]);leafMarkers.splice(i,1);updList();if(simOn)runSim();}
function updList(){$('dcnt').textContent=devices.length;$('dlist').innerHTML=devices.map((d,i)=>`<div class="di"><div><span class="dn">${d.id}</span> <span class="dc">${d.lat.toFixed(4)},${d.lng.toFixed(4)}</span></div><span class="dx" onclick="removeDevice(${i})">X</span></div>`).join('');}
function clearAll(){for(const m of leafMarkers)lmap.removeLayer(m);leafMarkers=[];devices=[];devN=0;clearOL();simOn=false;updList();$('vb').textContent='READY';$('vb').className='vb v-R';$('stats').innerHTML='<div class="sr"><span class="sl">Place devices first</span></div>';$('fails').innerHTML='<div style="font-size:10px;color:#4b5563">No sim yet</div>';$('iceB').style.width='0%';$('iceB').textContent='0%';updateRvOverlay();}
function clearOL(){for(const o of overlays)lmap.removeLayer(o);overlays=[];}

document.querySelectorAll('input[type="range"]').forEach(el=>el.addEventListener('input',()=>{
  $('vR').textContent=$('sR').value+'m';$('vA').textContent=$('sA').value+'°';
  $('vB').textContent=$('sB').value+'mm';$('vF').textContent=$('sF').value+' L/min';
  $('vW').textContent=$('sW').value+' m/s';
  if(simOn)runSim();
}));
$('envP').addEventListener('change',()=>{const e=getEnv();$('sW').value=e.wind;$('vW').textContent=e.wind+' m/s';if(simOn)runSim();});

// ═══════════════════════════════
// SEARCH
// ═══════════════════════════════
let sto;
$('sIn').addEventListener('input',()=>{clearTimeout(sto);const q=$('sIn').value.trim();if(q.length<2){$('sRes').style.display='none';return;}sto=setTimeout(()=>{fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=kr&limit=5`).then(r=>r.json()).then(d=>{if(!d.length){$('sRes').style.display='none';return;}$('sRes').innerHTML=d.map(x=>`<div class="si" data-lat="${x.lat}" data-lon="${x.lon}">${x.display_name}</div>`).join('');$('sRes').style.display='block';});},400);});
$('sRes').addEventListener('click',e=>{const t=e.target.closest('.si');if(!t)return;const la=+t.dataset.lat,lo=+t.dataset.lon;lmap.setView([la,lo],17);mapCenter={lat:la,lng:lo};$('sRes').style.display='none';$('sIn').value=t.textContent;});
document.addEventListener('click',e=>{if(!e.target.closest('.sbox'))$('sRes').style.display='none';});
$('qLoc').addEventListener('change',e=>{if(!e.target.value)return;const[a,b]=e.target.value.split(',').map(Number);lmap.setView([a,b],17);mapCenter={lat:a,lng:b};});

// ═══════════════════════════════
// SIMULATION
// ═══════════════════════════════
function runSim(){
  if(!devices.length)return;
  simOn=true;$('badge').textContent='SIMULATION';$('badge').className='badge b-sim';
  clearOL();
  const env=getEnv(),s=getSet();
  let tE=1;if(env.temp<-10)tE=.7;else if(env.temp<-5)tE=.85;else if(env.temp<0)tE=.95;
  const eR=s.range*tE;
  const drift=env.wind*s.range*.05*Math.sin(env.wdir*Math.PI/180);
  let ice=0;const rT=env.temp-2;if(rT<=0){ice+=.4;ice+=Math.min(.3,Math.abs(rT)*.02);}if(env.hum>70)ice+=.1;if(['snow','sleet','freezing_rain'].includes(env.prec))ice+=.2;if(env.wind<2&&env.cloud<30)ice+=.1;ice=Math.min(1,ice);
  const reg=$('envP').value.split('_')[0];const fD=FROST[reg]||FROST.default;const fR=s.burial>0&&s.burial<fD;

  for(const d of devices){
    overlays.push(L.circle([d.lat,d.lng],{radius:eR,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:.25,weight:2,dashArray:'5,5'}).addTo(lmap));
    overlays.push(L.circle([d.lat,d.lng],{radius:s.range,color:'#60a5fa',fillColor:'#60a5fa',fillOpacity:.07,weight:1,dashArray:'3,6'}).addTo(lmap));
    if(Math.abs(drift)>.5){const dL=drift*Math.cos(env.wdir*Math.PI/180)/111320;const dN=drift*Math.sin(env.wdir*Math.PI/180)/(111320*Math.cos(d.lat*Math.PI/180));overlays.push(L.polyline([[d.lat,d.lng],[d.lat+dL,d.lng+dN]],{color:'#a855f7',weight:2,dashArray:'4,4'}).addTo(lmap));}
  }

  let maxGap=0;const fails=[];
  if(devices.length>=2){for(let i=0;i<devices.length;i++)for(let j=i+1;j<devices.length;j++){const dd=lmap.distance([devices[i].lat,devices[i].lng],[devices[j].lat,devices[j].lng]);const g=dd-eR*2;if(g>maxGap)maxGap=g;if(g>10){const ml=(devices[i].lat+devices[j].lat)/2,mn=(devices[i].lng+devices[j].lng)/2;overlays.push(L.circle([ml,mn],{radius:g/2,color:'#ef4444',fillColor:'#ef4444',fillOpacity:.15,weight:2,dashArray:'6,4'}).addTo(lmap));const tt=L.tooltip({permanent:true,direction:'center'}).setLatLng([ml,mn]).setContent(`<div style="background:#450a0a;color:#f87171;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;border:1px solid #dc2626">${g.toFixed(0)}m gap</div>`);lmap.addLayer(tt);overlays.push(tt);}}}

  if(maxGap>10)fails.push({s:'critical',t:`GAP-001 ${maxGap.toFixed(0)}m gap`,d:'Max 10m'});
  else if(maxGap>5)fails.push({s:'warning',t:`GAP-002 ${maxGap.toFixed(0)}m gap`,d:'Near limit'});
  if(Math.abs(drift)>eR*.3)fails.push({s:'warning',t:'WIND-001 Drift',d:`${drift.toFixed(1)}m`});
  if(fR)fails.push({s:'critical',t:'FROST-001',d:`${s.burial}mm < ${fD}mm`});
  const cr=fails.filter(f=>f.s==='critical').length;
  let v='P';if(cr)v='F';else if(fails.length)v='C';

  $('vb').textContent=v==='F'?'FAIL':v==='C'?'CONDITIONAL PASS':'PASS';
  $('vb').className='vb v-'+v;
  $('stats').innerHTML=`
    <div class="sr"><span class="sl">Devices</span><span class="sv">${devices.length}</span></div>
    <div class="sr"><span class="sl">Eff Range</span><span class="sv">${eR.toFixed(1)}m</span></div>
    <div class="sr"><span class="sl">Drift</span><span class="sv ${Math.abs(drift)>1?'warn':''}">${drift.toFixed(1)}m</span></div>
    <div class="sr"><span class="sl">Max Gap</span><span class="sv ${maxGap>10?'crit':maxGap>5?'warn':'good'}">${maxGap.toFixed(1)}m</span></div>
    <div class="sr"><span class="sl">Frost</span><span class="sv">${fD}mm</span></div>
    <div class="sr"><span class="sl">Burial</span><span class="sv ${fR?'crit':'good'}">${s.burial}mm</span></div>
    <div class="sr"><span class="sl">Ice Risk</span><span class="sv ${ice>.7?'crit':ice>.4?'warn':'good'}">${(ice*100).toFixed(0)}%</span></div>`;
  $('iceB').style.width=`${ice*100}%`;$('iceB').textContent=`${(ice*100).toFixed(0)}%`;
  $('fails').innerHTML=fails.length?fails.map(f=>`<div class="fi ${f.s==='warning'?'fw':''}"><div class="ft">${f.t}</div><div class="fd">${f.d}</div></div>`).join(''):'<div style="font-size:10px;color:#4ade80">No failures</div>';

  updateRvOverlay();
}

// ═══════════════════════════════
// THREE.JS 3D
// ═══════════════════════════════
let scene,camera,renderer,clock;
let mF=false,mB=false,mL=false,mR=false;
let eu={x:0,y:0};
let init3=false,spMesh=[],pSys=[];

function init3D(){
  const c=$('v3d');scene=new THREE.Scene();scene.background=new THREE.Color(0x0a1628);scene.fog=new THREE.FogExp2(0x0a1628,.008);
  camera=new THREE.PerspectiveCamera(70,c.clientWidth/c.clientHeight,.1,1000);camera.position.set(0,1.7,0);
  renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(c.clientWidth,c.clientHeight);renderer.shadowMap.enabled=true;c.appendChild(renderer.domElement);
  clock=new THREE.Clock();
  scene.add(new THREE.AmbientLight(0x334466,.6));
  const dl=new THREE.DirectionalLight(0x8899bb,.4);dl.position.set(50,80,30);scene.add(dl);
  scene.add(new THREE.HemisphereLight(0x2244aa,0x111122,.3));
  // sky
  scene.add(new THREE.Mesh(new THREE.SphereGeometry(400,32,32),new THREE.MeshBasicMaterial({color:0x0a1628,side:THREE.BackSide})));
  // road
  const rd=new THREE.Mesh(new THREE.PlaneGeometry(12,200),new THREE.MeshStandardMaterial({color:0x2a2a2a,roughness:.9}));rd.rotation.x=-Math.PI/2;rd.position.y=.01;rd.receiveShadow=true;scene.add(rd);
  const lm=new THREE.MeshBasicMaterial({color:0xddaa33});
  for(let z=-95;z<100;z+=4){const l=new THREE.Mesh(new THREE.PlaneGeometry(.15,2),lm);l.rotation.x=-Math.PI/2;l.position.set(0,.02,z);scene.add(l);}
  const wm=new THREE.MeshBasicMaterial({color:0xcccccc});
  [-6,6].forEach(x=>{const l=new THREE.Mesh(new THREE.PlaneGeometry(.15,200),wm);l.rotation.x=-Math.PI/2;l.position.set(x,.02,0);scene.add(l);});
  const gm=new THREE.MeshStandardMaterial({color:0x888888,metalness:.6,roughness:.3});
  [-7,7].forEach(x=>{for(let z=-95;z<100;z+=3){const p=new THREE.Mesh(new THREE.BoxGeometry(.08,.8,.05),gm);p.position.set(x,.4,z);scene.add(p);}const r=new THREE.Mesh(new THREE.BoxGeometry(.06,.06,200),gm);r.position.set(x,.7,0);scene.add(r);});
  for(let z=-80;z<=80;z+=40)[-9,9].forEach(x=>{scene.add(new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,6),new THREE.MeshStandardMaterial({color:0x555555})).position?undefined:undefined);const po=new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,6),new THREE.MeshStandardMaterial({color:0x555555,metalness:.5}));po.position.set(x,3,z);scene.add(po);const li=new THREE.PointLight(0xffdd88,.5,20);li.position.set(x,6,z);scene.add(li);scene.add(new THREE.Mesh(new THREE.SphereGeometry(.15),new THREE.MeshBasicMaterial({color:0xffdd88})).translateX(x).translateY(6).translateZ(z)||new THREE.Object3D());const b=new THREE.Mesh(new THREE.SphereGeometry(.15),new THREE.MeshBasicMaterial({color:0xffdd88}));b.position.set(x,6,z);scene.add(b);});
  // ground
  const gr=new THREE.Mesh(new THREE.PlaneGeometry(400,400),new THREE.MeshStandardMaterial({color:0x1a2810}));gr.rotation.x=-Math.PI/2;gr.position.y=-.05;scene.add(gr);
  // trees
  for(let i=0;i<30;i++){const x=(Math.random()>.5?1:-1)*(12+Math.random()*30),z=-90+Math.random()*180;
    const tr=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,2),new THREE.MeshStandardMaterial({color:0x3a2a1a}));tr.position.set(x,1,z);scene.add(tr);
    const lv=new THREE.Mesh(new THREE.ConeGeometry(1.5,4,6),new THREE.MeshStandardMaterial({color:0x1a3a10}));lv.position.set(x,4,z);scene.add(lv);}
  // snow
  const sn=3000,sg=new THREE.BufferGeometry(),sp=new Float32Array(sn*3);
  for(let i=0;i<sn;i++){sp[i*3]=Math.random()*200-100;sp[i*3+1]=Math.random()*50;sp[i*3+2]=Math.random()*200-100;}
  sg.setAttribute('position',new THREE.BufferAttribute(sp,3));
  const sm=new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:.15,transparent:true,opacity:.8}));sm.userData.isSnow=true;scene.add(sm);
  window.addEventListener('resize',()=>{const cc=$('v3d');camera.aspect=cc.clientWidth/cc.clientHeight;camera.updateProjectionMatrix();renderer.setSize(cc.clientWidth,cc.clientHeight);});
  init3=true;
}

function rebuildDev3D(){
  for(const m of spMesh)scene.remove(m);spMesh=[];
  for(const p of pSys)scene.remove(p);pSys=[];
  if(!devices.length)return;
  const cLat=devices.reduce((s,d)=>s+d.lat,0)/devices.length;
  const cLng=devices.reduce((s,d)=>s+d.lng,0)/devices.length;
  const s=getSet();
  devices.forEach((d,i)=>{
    const dx=(d.lng-cLng)*111320*Math.cos(cLat*Math.PI/180);
    const dz=-(d.lat-cLat)*111320;
    const g=new THREE.Group();
    g.add(new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.05,16),new THREE.MeshStandardMaterial({color:0xccaa33,metalness:.7,roughness:.3})).translateY(.03)||new THREE.Object3D());
    const pl=new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.05,16),new THREE.MeshStandardMaterial({color:0xccaa33,metalness:.7,roughness:.3}));pl.position.y=.03;g.add(pl);
    const nz=new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,.15,8),new THREE.MeshStandardMaterial({color:0x888888,metalness:.8,roughness:.2}));nz.position.y=.12;g.add(nz);
    // label
    const cv=document.createElement('canvas');cv.width=128;cv.height=64;const cx=cv.getContext('2d');cx.fillStyle='rgba(17,24,39,0.8)';cx.fillRect(0,0,128,64);cx.fillStyle='#fbbf24';cx.font='bold 20px monospace';cx.textAlign='center';cx.fillText(d.id,64,38);
    const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv),transparent:true}));sp.scale.set(1.5,.75,1);sp.position.y=1.5;g.add(sp);
    g.position.set(dx,0,dz);scene.add(g);spMesh.push(g);
    // particles
    const pc=400,pg=new THREE.BufferGeometry(),pp=new Float32Array(pc*3),pcl=new Float32Array(pc*3);
    for(let j=0;j<pc;j++){const a=Math.random()*Math.PI*2,r=Math.random()*s.range;pp[j*3]=dx+Math.cos(a)*r;pp[j*3+1]=Math.random()*.4;pp[j*3+2]=dz+Math.sin(a)*r;pcl[j*3]=.2+Math.random()*.3;pcl[j*3+1]=.5+Math.random()*.3;pcl[j*3+2]=.9;}
    pg.setAttribute('position',new THREE.BufferAttribute(pp,3));pg.setAttribute('color',new THREE.BufferAttribute(pcl,3));
    const pts=new THREE.Points(pg,new THREE.PointsMaterial({size:.08,vertexColors:true,transparent:true,opacity:.6}));pts.userData={cx:dx,cz:dz,range:s.range};scene.add(pts);pSys.push(pts);
    // range circle
    const rc=new THREE.Mesh(new THREE.RingGeometry(s.range-.1,s.range,32),new THREE.MeshBasicMaterial({color:0x3b82f6,transparent:true,opacity:.5,side:THREE.DoubleSide}));rc.rotation.x=-Math.PI/2;rc.position.set(dx,.03,dz);scene.add(rc);spMesh.push(rc);
  });
  if(devices.length){const d0=devices[0];const cl=devices.reduce((s,d)=>s+d.lat,0)/devices.length;const cn=devices.reduce((s,d)=>s+d.lng,0)/devices.length;const dx2=(d0.lng-cn)*111320*Math.cos(cl*Math.PI/180);const dz2=-(d0.lat-cl)*111320;camera.position.set(dx2-5,1.7,dz2+10);eu.y=Math.atan2(5,-10);}
}

function start3D(){if(!init3)init3D();rebuildDev3D();anim3D();}
function anim3D(){
  if(curTab!=='3d')return;requestAnimationFrame(anim3D);
  const dt=clock.getDelta(),sp=5*dt;
  const dr=new THREE.Vector3();camera.getWorldDirection(dr);dr.y=0;dr.normalize();
  const rt=new THREE.Vector3().crossVectors(dr,new THREE.Vector3(0,1,0));
  if(mF)camera.position.addScaledVector(dr,sp);if(mB)camera.position.addScaledVector(dr,-sp);
  if(mL)camera.position.addScaledVector(rt,-sp);if(mR)camera.position.addScaledVector(rt,sp);
  camera.position.y=1.7;camera.rotation.order='YXZ';camera.rotation.y=eu.y;camera.rotation.x=eu.x;
  scene.traverse(o=>{if(o.userData.isSnow){const p=o.geometry.attributes.position;for(let i=0;i<p.count;i++){p.array[i*3+1]-=dt*2;p.array[i*3]+=dt*.3;if(p.array[i*3+1]<0){p.array[i*3+1]=40;p.array[i*3]=Math.random()*200-100;}}p.needsUpdate=true;}});
  for(const ps of pSys){const p=ps.geometry.attributes.position;for(let i=0;i<p.count;i++){p.array[i*3+1]-=dt*.5;if(p.array[i*3+1]<0){const a=Math.random()*Math.PI*2,r=Math.random()*ps.userData.range;p.array[i*3]=ps.userData.cx+Math.cos(a)*r;p.array[i*3+1]=Math.random()*.3+.1;p.array[i*3+2]=ps.userData.cz+Math.sin(a)*r;}}p.needsUpdate=true;}
  $('hudP').textContent=`Pos: ${camera.position.x.toFixed(1)}, ${camera.position.z.toFixed(1)}`;
  renderer.render(scene,camera);
}

document.addEventListener('keydown',e=>{if(curTab!=='3d')return;if(e.key==='w'||e.key==='W'||e.key==='ArrowUp')mF=true;if(e.key==='s'||e.key==='S'||e.key==='ArrowDown')mB=true;if(e.key==='a'||e.key==='A'||e.key==='ArrowLeft')mL=true;if(e.key==='d'||e.key==='D'||e.key==='ArrowRight')mR=true;});
document.addEventListener('keyup',e=>{if(e.key==='w'||e.key==='W'||e.key==='ArrowUp')mF=false;if(e.key==='s'||e.key==='S'||e.key==='ArrowDown')mB=false;if(e.key==='a'||e.key==='A'||e.key==='ArrowLeft')mL=false;if(e.key==='d'||e.key==='D'||e.key==='ArrowRight')mR=false;});
$('v3d').addEventListener('click',function(){this.requestPointerLock();});
document.addEventListener('mousemove',e=>{if(document.pointerLockElement!==$('v3d'))return;eu.y-=e.movementX*.002;eu.x-=e.movementY*.002;eu.x=Math.max(-Math.PI/2.5,Math.min(Math.PI/2.5,eu.x));});
</script>
</body>
</html>
