<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>염수분사장치 - 위성지도 시뮬레이션</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #0a0e1a;
  color: #e0e0e0;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
  overflow: hidden;
}

.app {
  display: grid;
  grid-template-columns: 320px 1fr 340px;
  grid-template-rows: 52px 1fr;
  height: 100vh;
}

/* ── 헤더 ── */
.header {
  grid-column: 1 / -1;
  background: #111827;
  border-bottom: 1px solid #1e293b;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}
.header h1 { font-size: 15px; font-weight: 600; color: #60a5fa; }
.header-right { display: flex; align-items: center; gap: 14px; }
.mode-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.mode-place { background: #1e40af; color: #93c5fd; }
.mode-sim { background: #065f46; color: #6ee7b7; }
.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #22c55e;
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* ── 좌측 패널 ── */
.panel-left {
  background: #111827;
  border-right: 1px solid #1e293b;
  padding: 14px;
  overflow-y: auto;
}
.section-title {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: #60a5fa;
  margin: 14px 0 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid #1e293b;
}
.section-title:first-child { margin-top: 0; }

label.param {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #94a3b8;
  margin-top: 6px;
}
label.param .v { color: #60a5fa; font-weight: 600; }
input[type="range"] {
  width: 100%;
  accent-color: #60a5fa;
  margin-bottom: 2px;
}
select.ctrl {
  width: 100%;
  background: #1e293b;
  color: #e0e0e0;
  border: 1px solid #334155;
  padding: 5px 8px;
  border-radius: 4px;
  font-size: 12px;
  margin-top: 4px;
}
.btn {
  display: inline-block;
  padding: 7px 16px;
  border-radius: 4px;
  border: 1px solid #334155;
  background: #1e293b;
  color: #e0e0e0;
  font-size: 12px;
  cursor: pointer;
  transition: all .15s;
  margin-top: 4px;
}
.btn:hover { background: #334155; }
.btn-primary { background: #2563eb; border-color: #3b82f6; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-danger { background: #991b1b; border-color: #dc2626; color: #fca5a5; }
.btn-warning { background: #78350f; border-color: #d97706; color: #fcd34d; }
.btn-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }

.device-list { margin-top: 8px; }
.device-item {
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 6px;
  padding: 8px 10px;
  margin-bottom: 6px;
  font-size: 11px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.device-item .name { color: #fbbf24; font-weight: 600; }
.device-item .coords { color: #64748b; }
.device-item .remove {
  color: #ef4444;
  cursor: pointer;
  font-size: 13px;
  padding: 2px 6px;
  border-radius: 3px;
}
.device-item .remove:hover { background: #450a0a; }

.instructions {
  background: #0f172a;
  border: 1px solid #1e293b;
  border-radius: 6px;
  padding: 10px;
  font-size: 11px;
  color: #94a3b8;
  line-height: 1.6;
  margin-top: 8px;
}
.instructions strong { color: #60a5fa; }

/* ── 지도 ── */
.map-container {
  position: relative;
}
#map {
  width: 100%;
  height: 100%;
  z-index: 1;
}
.map-overlay-top {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  background: rgba(17,24,39,0.9);
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 12px;
  color: #94a3b8;
  border: 1px solid #334155;
  pointer-events: none;
}
.map-overlay-top span { color: #60a5fa; font-weight: 600; }

/* ── 우측 패널 ── */
.panel-right {
  background: #111827;
  border-left: 1px solid #1e293b;
  padding: 14px;
  overflow-y: auto;
}

.verdict-box {
  text-align: center;
  padding: 14px;
  border-radius: 8px;
  margin-bottom: 14px;
  font-size: 22px;
  font-weight: 800;
  letter-spacing: 2px;
}
.verdict-FAIL { background: #450a0a; color: #f87171; border: 2px solid #dc2626; }
.verdict-PASS { background: #052e16; color: #4ade80; border: 2px solid #16a34a; }
.verdict-CONDITIONAL { background: #422006; color: #fbbf24; border: 2px solid #d97706; }
.verdict-READY { background: #1e293b; color: #64748b; border: 2px solid #334155; }

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 5px 0;
  font-size: 11px;
  border-bottom: 1px solid #1e293b;
}
.stat-row .l { color: #94a3b8; }
.stat-row .v { font-weight: 600; }
.critical { color: #f87171; }
.warning { color: #fbbf24; }
.good { color: #4ade80; }

.failure-item {
  background: #1e1215;
  border-left: 3px solid #dc2626;
  padding: 7px 10px;
  margin-bottom: 6px;
  border-radius: 0 4px 4px 0;
  font-size: 11px;
}
.failure-item.warn { background: #1e1a0f; border-left-color: #d97706; }
.failure-item .ft { font-weight: 600; color: #f87171; }
.failure-item.warn .ft { color: #fbbf24; }
.failure-item .fd { color: #94a3b8; margin-top: 3px; }

.risk-bar-outer {
  background: #1e293b;
  border-radius: 4px;
  height: 20px;
  overflow: hidden;
  margin-top: 4px;
}
.risk-bar-inner {
  height: 100%;
  background: linear-gradient(90deg, #dc2626, #f87171);
  transition: width .4s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  color: #fff;
}

/* 검색 */
.search-box {
  position: relative;
  margin-bottom: 8px;
}
.search-box input {
  width: 100%;
  background: #1e293b;
  border: 1px solid #334155;
  color: #e0e0e0;
  padding: 7px 10px;
  border-radius: 4px;
  font-size: 12px;
}
.search-box input::placeholder { color: #4b5563; }
.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #1e293b;
  border: 1px solid #334155;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}
.search-results .sr-item {
  padding: 8px 10px;
  font-size: 12px;
  cursor: pointer;
  border-bottom: 1px solid #111827;
}
.search-results .sr-item:hover { background: #334155; }

/* leaflet 커스텀 */
.leaflet-container { background: #0f172a; }
.spray-icon {
  background: none;
  border: none;
}
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <h1>Brine Spray Simulation — Satellite Map</h1>
    <div class="header-right">
      <div class="mode-badge mode-place" id="modeBadge">PLACEMENT MODE</div>
      <div class="status-dot"></div>
    </div>
  </div>

  <!-- 좌측 -->
  <div class="panel-left">

    <div class="section-title">Location Search</div>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search location (e.g. 대관령, 서울 강남)">
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="section-title">Quick Locations</div>
    <select class="ctrl" id="quickLoc">
      <option value="">-- Select --</option>
      <option value="37.6879,128.7597">Daegwallyeong Pass (대관령)</option>
      <option value="37.5665,126.9780">Seoul City Hall</option>
      <option value="37.2747,127.0094">Suwon Interchange</option>
      <option value="35.1796,129.0756">Busan Gwangan Bridge</option>
      <option value="36.3504,127.3845">Daejeon IC</option>
      <option value="37.8813,127.7298">Chuncheon (춘천)</option>
      <option value="33.4996,126.5312">Jeju (제주)</option>
    </select>

    <div class="section-title">Placement</div>
    <div class="instructions">
      <strong>1.</strong> 지도를 이동/줌하여 설치 위치로 이동<br>
      <strong>2.</strong> 지도를 클릭하여 분사장치 배치<br>
      <strong>3.</strong> "Run Simulation" 클릭
    </div>

    <div class="section-title">Device Settings</div>
    <label class="param">Spray Range <span class="v" id="vRange">8.0 m</span></label>
    <input type="range" id="sRange" min="2" max="25" value="8" step="0.5">
    <label class="param">Spray Angle <span class="v" id="vAngle">120°</span></label>
    <input type="range" id="sAngle" min="30" max="360" value="120" step="10">
    <label class="param">Burial Depth <span class="v" id="vBurial">400 mm</span></label>
    <input type="range" id="sBurial" min="0" max="1200" value="400" step="50">
    <label class="param">Flow Rate <span class="v" id="vFlow">5.0 L/min</span></label>
    <input type="range" id="sFlow" min="1" max="20" value="5" step="0.5">

    <div class="section-title">Environment</div>
    <select class="ctrl" id="envPreset">
      <option value="gangwon_night">Gangwon - Winter Night (-15°C, Snow)</option>
      <option value="gangwon_dawn">Gangwon - Winter Dawn (-12°C, Clear)</option>
      <option value="seoul_night">Seoul - Winter Night (-8°C, Snow)</option>
      <option value="seoul_dawn">Seoul - Winter Dawn (-12°C, Clear)</option>
      <option value="busan_morning">Busan - Winter Morning (-2°C, Freezing Rain)</option>
      <option value="mild">Mild Conditions (-3°C, Light Snow)</option>
    </select>
    <label class="param">Wind Speed <span class="v" id="vWind">5.0 m/s</span></label>
    <input type="range" id="sWind" min="0" max="15" value="5" step="0.5">

    <div class="section-title">Placed Devices (<span id="devCountLabel">0</span>)</div>
    <div class="device-list" id="deviceList"></div>

    <div class="btn-row">
      <button class="btn btn-primary" id="btnRun">Run Simulation</button>
      <button class="btn btn-danger" id="btnClear">Clear All</button>
    </div>
  </div>

  <!-- 지도 -->
  <div class="map-container">
    <div class="map-overlay-top" id="mapOverlay">
      Click on the map to <span>place spray devices</span>
    </div>
    <div id="map"></div>
  </div>

  <!-- 우측 판정 -->
  <div class="panel-right">
    <div class="section-title">Judgment</div>
    <div class="verdict-box verdict-READY" id="verdictBox">READY</div>

    <div class="section-title">Statistics</div>
    <div id="statsBox">
      <div class="stat-row"><span class="l">Place devices and run simulation</span></div>
    </div>

    <div class="section-title">Ice Formation Risk</div>
    <div class="risk-bar-outer">
      <div class="risk-bar-inner" id="iceBar" style="width:0%">0%</div>
    </div>

    <div class="section-title" style="margin-top:14px">Failure Observations</div>
    <div id="failBox">
      <div style="font-size:11px;color:#4b5563;">No simulation run yet.</div>
    </div>

    <div class="section-title" style="margin-top:14px">Disclaimer</div>
    <div style="font-size:10px;color:#4b5563;line-height:1.5;">
      This system provides JUDGMENT INFORMATION only.
      All DECISIONS and ACCOUNTABILITY remain with qualified engineers.
      This system does not design, decide, or replace professional judgment.
      L0 rule-based simulation — not a substitute for physical testing.
    </div>
  </div>

</div>

<script>
// ═════════════════════════════════════════════
//  MAP INIT
// ═════════════════════════════════════════════

const map = L.map('map', {
  center: [37.6879, 128.7597], // 대관령
  zoom: 17,
  zoomControl: true,
});

// 위성 타일 (무료 - ESRI World Imagery)
const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution: 'Tiles &copy; Esri', maxZoom: 19 }
).addTo(map);

const streets = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { attribution: '&copy; OSM', maxZoom: 19 }
);

const hybrid = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 19, opacity: 0.7 }
).addTo(map);

L.control.layers({
  'Satellite': satellite,
  'Street Map': streets,
}, {
  'Road Labels': hybrid,
}).addTo(map);


// ═════════════════════════════════════════════
//  ENV PRESETS
// ═════════════════════════════════════════════

const ENV = {
  gangwon_night: { temp: -15, wind: 5, windDir: 270, humidity: 75, precip: 'snow', precipMm: 5, cloud: 95 },
  gangwon_dawn:  { temp: -12, wind: 1.5, windDir: 0, humidity: 70, precip: 'none', precipMm: 0, cloud: 30 },
  seoul_night:   { temp: -8, wind: 3.5, windDir: 315, humidity: 65, precip: 'snow', precipMm: 2, cloud: 90 },
  seoul_dawn:    { temp: -12, wind: 1.5, windDir: 0, humidity: 70, precip: 'none', precipMm: 0, cloud: 30 },
  busan_morning: { temp: -2, wind: 6, windDir: 180, humidity: 80, precip: 'freezing_rain', precipMm: 1.5, cloud: 80 },
  mild:          { temp: -3, wind: 2, windDir: 90, humidity: 55, precip: 'snow', precipMm: 1, cloud: 60 },
};

const FROST_DEPTH = { gangwon: 900, seoul: 600, busan: 300, daejeon: 500, default: 600 };


// ═════════════════════════════════════════════
//  DEVICE MANAGEMENT
// ═════════════════════════════════════════════

let devices = [];
let deviceMarkers = [];
let coverageCircles = [];
let simRunning = false;
let deviceCounter = 0;

function getDeviceSettings() {
  return {
    range: +document.getElementById('sRange').value,
    angle: +document.getElementById('sAngle').value,
    burial: +document.getElementById('sBurial').value,
    flow: +document.getElementById('sFlow').value,
  };
}

function getEnv() {
  const key = document.getElementById('envPreset').value;
  const e = { ...ENV[key] };
  e.wind = +document.getElementById('sWind').value;
  return e;
}

function createDeviceIcon(id) {
  return L.divIcon({
    className: 'spray-icon',
    html: `<svg width="32" height="32" viewBox="0 0 32 32">
      <circle cx="16" cy="16" r="10" fill="#fbbf24" fill-opacity="0.9" stroke="#f59e0b" stroke-width="2"/>
      <circle cx="16" cy="16" r="4" fill="#111827"/>
      <text x="16" y="26" text-anchor="middle" fill="#fbbf24" font-size="7" font-weight="bold">${id}</text>
    </svg>`,
    iconSize: [32, 32],
    iconAnchor: [16, 16],
  });
}

function addDevice(latlng) {
  deviceCounter++;
  const id = `SPR-${String(deviceCounter).padStart(3, '0')}`;
  const settings = getDeviceSettings();
  const dev = { id, lat: latlng.lat, lng: latlng.lng, ...settings };
  devices.push(dev);

  const marker = L.marker(latlng, {
    icon: createDeviceIcon(id),
    draggable: true,
  }).addTo(map);

  marker.on('dragend', (e) => {
    const pos = e.target.getLatLng();
    dev.lat = pos.lat;
    dev.lng = pos.lng;
    if (simRunning) runSimulation();
  });

  marker.bindTooltip(id, { permanent: false, direction: 'top', offset: [0, -16] });
  deviceMarkers.push(marker);

  updateDeviceList();
}

function removeDevice(index) {
  devices.splice(index, 1);
  map.removeLayer(deviceMarkers[index]);
  deviceMarkers.splice(index, 1);
  updateDeviceList();
  if (simRunning) runSimulation();
}

function updateDeviceList() {
  document.getElementById('devCountLabel').textContent = devices.length;
  const list = document.getElementById('deviceList');
  list.innerHTML = devices.map((d, i) => `
    <div class="device-item">
      <div>
        <span class="name">${d.id}</span>
        <span class="coords">${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}</span>
      </div>
      <span class="remove" onclick="removeDevice(${i})">X</span>
    </div>
  `).join('');
}

map.on('click', (e) => {
  addDevice(e.latlng);
});


// ═════════════════════════════════════════════
//  SIMULATION
// ═════════════════════════════════════════════

function runSimulation() {
  if (devices.length === 0) return;

  simRunning = true;
  document.getElementById('modeBadge').textContent = 'SIMULATION MODE';
  document.getElementById('modeBadge').className = 'mode-badge mode-sim';
  document.getElementById('mapOverlay').innerHTML = 'Simulation <span>ACTIVE</span> — drag devices to adjust';

  clearCoverage();

  const env = getEnv();
  const settings = getDeviceSettings();

  // 온도 효율
  let tempEff = 1.0;
  if (env.temp < -10) tempEff = 0.7;
  else if (env.temp < -5) tempEff = 0.85;
  else if (env.temp < 0) tempEff = 0.95;
  const effRange = settings.range * tempEff;

  // 바람 편류 (미터)
  const driftFactor = 0.05;
  const drift = env.wind * settings.range * driftFactor;

  // 결빙 위험
  let iceRisk = 0;
  const roadTemp = env.temp - 2;
  if (roadTemp <= 0) { iceRisk += 0.4; iceRisk += Math.min(0.3, Math.abs(roadTemp) * 0.02); }
  if (env.humidity > 70) iceRisk += 0.1;
  if (['snow', 'sleet', 'freezing_rain'].includes(env.precip)) iceRisk += 0.2;
  if (env.wind < 2 && env.cloud < 30) iceRisk += 0.1;
  iceRisk = Math.min(1, iceRisk);

  // 동결심도
  const presetKey = document.getElementById('envPreset').value;
  const region = presetKey.split('_')[0];
  const frostDepth = FROST_DEPTH[region] || FROST_DEPTH.default;
  const frostRisk = settings.burial > 0 && settings.burial < frostDepth;

  // 각 장치의 커버리지 원 그리기
  for (const dev of devices) {
    // 유효 커버리지 (파란색)
    const effCircle = L.circle([dev.lat, dev.lng], {
      radius: effRange,
      color: '#3b82f6',
      fillColor: '#3b82f6',
      fillOpacity: 0.25,
      weight: 2,
      dashArray: '5,5',
    }).addTo(map);
    coverageCircles.push(effCircle);

    // 최대 커버리지 (연한 파란색)
    const maxCircle = L.circle([dev.lat, dev.lng], {
      radius: settings.range,
      color: '#60a5fa',
      fillColor: '#60a5fa',
      fillOpacity: 0.08,
      weight: 1,
      dashArray: '3,6',
    }).addTo(map);
    coverageCircles.push(maxCircle);

    // 바람 편류 표시
    if (drift > 0.5) {
      const windRad = env.windDir * Math.PI / 180;
      const dLat = drift * Math.cos(windRad) / 111320;
      const dLng = drift * Math.sin(windRad) / (111320 * Math.cos(dev.lat * Math.PI / 180));
      const driftLine = L.polyline(
        [[dev.lat, dev.lng], [dev.lat + dLat, dev.lng + dLng]],
        { color: '#a855f7', weight: 2, dashArray: '4,4', opacity: 0.8 }
      ).addTo(map);
      coverageCircles.push(driftLine);

      const driftCircle = L.circle([dev.lat + dLat, dev.lng + dLng], {
        radius: effRange * 0.6,
        color: '#a855f7',
        fillColor: '#a855f7',
        fillOpacity: 0.1,
        weight: 1,
      }).addTo(map);
      coverageCircles.push(driftCircle);
    }
  }

  // 장치 간 거리 분석
  const failures = [];
  let maxGap = 0;

  if (devices.length >= 2) {
    for (let i = 0; i < devices.length; i++) {
      for (let j = i + 1; j < devices.length; j++) {
        const d = map.distance([devices[i].lat, devices[i].lng], [devices[j].lat, devices[j].lng]);
        const gap = d - effRange * 2;
        if (gap > maxGap) maxGap = gap;
        if (gap > 10) {
          // 미커버 구간 표시
          const midLat = (devices[i].lat + devices[j].lat) / 2;
          const midLng = (devices[i].lng + devices[j].lng) / 2;
          const gapCircle = L.circle([midLat, midLng], {
            radius: gap / 2,
            color: '#ef4444',
            fillColor: '#ef4444',
            fillOpacity: 0.15,
            weight: 2,
            dashArray: '6,4',
          }).addTo(map);
          coverageCircles.push(gapCircle);

          const gapLabel = L.tooltip({ permanent: true, direction: 'center', className: '' })
            .setLatLng([midLat, midLng])
            .setContent(`<div style="background:#450a0a;color:#f87171;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;border:1px solid #dc2626;">${gap.toFixed(0)}m gap</div>`);
          map.addLayer(gapLabel);
          coverageCircles.push(gapLabel);
        }
      }
    }
  }

  // 판정 규칙
  const totalDevices = devices.length;
  const approxCoveredLength = totalDevices * effRange * 2;

  // 커버리지 (인접 장치 간 간격 기반 추정)
  if (maxGap > 20) {
    failures.push({ sev: 'critical', title: 'GAP-001 Large Uncovered Zone', desc: `${maxGap.toFixed(0)}m gap between devices (max 10m)` });
  } else if (maxGap > 10) {
    failures.push({ sev: 'critical', title: 'GAP-001 Uncovered Zone', desc: `${maxGap.toFixed(0)}m gap (max 10m)` });
  } else if (maxGap > 5) {
    failures.push({ sev: 'warning', title: 'GAP-002 Near-limit Gap', desc: `${maxGap.toFixed(0)}m gap approaching limit` });
  }

  if (drift > effRange * 0.3) {
    failures.push({ sev: 'warning', title: 'WIND-001 Spray Drift', desc: `${drift.toFixed(1)}m drift at ${env.wind}m/s wind` });
  }

  if (frostRisk) {
    failures.push({ sev: 'critical', title: 'FROST-001 Freeze Risk', desc: `Burial ${settings.burial}mm < frost depth ${frostDepth}mm (${region})` });
  }

  // 판정
  const criticals = failures.filter(f => f.sev === 'critical').length;
  let verdict = 'PASS';
  if (criticals > 0) verdict = 'FAIL';
  else if (failures.length > 0) verdict = 'CONDITIONAL';

  // UI 업데이트
  updateJudgmentUI(verdict, {
    devices: totalDevices,
    effRange,
    drift,
    maxGap,
    iceRisk,
    frostDepth,
    frostRisk,
    burial: settings.burial,
    criticals,
    warnings: failures.filter(f => f.sev === 'warning').length,
    failures,
  });
}

function clearCoverage() {
  for (const c of coverageCircles) map.removeLayer(c);
  coverageCircles = [];
}

function updateJudgmentUI(verdict, data) {
  const vbox = document.getElementById('verdictBox');
  vbox.textContent = verdict === 'CONDITIONAL' ? 'CONDITIONAL PASS' : verdict;
  vbox.className = `verdict-box verdict-${verdict}`;

  const covClass = (v) => v === 'good' ? 'good' : v;

  document.getElementById('statsBox').innerHTML = `
    <div class="stat-row"><span class="l">Devices Placed</span><span class="v">${data.devices}</span></div>
    <div class="stat-row"><span class="l">Effective Range</span><span class="v">${data.effRange.toFixed(1)} m</span></div>
    <div class="stat-row"><span class="l">Wind Drift</span><span class="v ${Math.abs(data.drift)>1?'warning':''}">${data.drift.toFixed(1)} m</span></div>
    <div class="stat-row"><span class="l">Max Gap</span><span class="v ${data.maxGap>10?'critical':data.maxGap>5?'warning':'good'}">${data.maxGap.toFixed(1)} m</span></div>
    <div class="stat-row"><span class="l">Frost Depth (${document.getElementById('envPreset').value.split('_')[0]})</span><span class="v">${data.frostDepth} mm</span></div>
    <div class="stat-row"><span class="l">Burial Depth</span><span class="v ${data.frostRisk?'critical':'good'}">${data.burial} mm</span></div>
    <div class="stat-row"><span class="l">Ice Risk</span><span class="v ${data.iceRisk>0.7?'critical':data.iceRisk>0.4?'warning':'good'}">${(data.iceRisk*100).toFixed(0)}%</span></div>
    <div class="stat-row"><span class="l">Critical Issues</span><span class="v ${data.criticals>0?'critical':'good'}">${data.criticals}</span></div>
    <div class="stat-row"><span class="l">Warnings</span><span class="v ${data.warnings>0?'warning':'good'}">${data.warnings}</span></div>
  `;

  const iceBar = document.getElementById('iceBar');
  iceBar.style.width = `${data.iceRisk * 100}%`;
  iceBar.textContent = `${(data.iceRisk * 100).toFixed(0)}%`;

  document.getElementById('failBox').innerHTML = data.failures.length === 0
    ? '<div style="font-size:11px;color:#4ade80;">No failures observed.</div>'
    : data.failures.map(f => `
        <div class="failure-item ${f.sev === 'warning' ? 'warn' : ''}">
          <div class="ft">${f.title}</div>
          <div class="fd">${f.desc}</div>
        </div>
      `).join('');
}


// ═════════════════════════════════════════════
//  SEARCH (Nominatim OpenStreetMap)
// ═════════════════════════════════════════════

let searchTimeout = null;
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');

searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  if (q.length < 2) { searchResults.style.display = 'none'; return; }
  searchTimeout = setTimeout(() => {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=kr&limit=5`)
      .then(r => r.json())
      .then(data => {
        if (data.length === 0) { searchResults.style.display = 'none'; return; }
        searchResults.innerHTML = data.map(d => `
          <div class="sr-item" data-lat="${d.lat}" data-lon="${d.lon}">${d.display_name}</div>
        `).join('');
        searchResults.style.display = 'block';
      });
  }, 400);
});

searchResults.addEventListener('click', (e) => {
  const item = e.target.closest('.sr-item');
  if (!item) return;
  const lat = +item.dataset.lat;
  const lon = +item.dataset.lon;
  map.setView([lat, lon], 17);
  searchResults.style.display = 'none';
  searchInput.value = item.textContent;
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-box')) searchResults.style.display = 'none';
});


// ═════════════════════════════════════════════
//  EVENTS
// ═════════════════════════════════════════════

document.getElementById('quickLoc').addEventListener('change', (e) => {
  if (!e.target.value) return;
  const [lat, lng] = e.target.value.split(',').map(Number);
  map.setView([lat, lng], 17);
});

document.getElementById('btnRun').addEventListener('click', runSimulation);

document.getElementById('btnClear').addEventListener('click', () => {
  for (const m of deviceMarkers) map.removeLayer(m);
  deviceMarkers = [];
  devices = [];
  deviceCounter = 0;
  clearCoverage();
  simRunning = false;
  updateDeviceList();
  document.getElementById('verdictBox').textContent = 'READY';
  document.getElementById('verdictBox').className = 'verdict-box verdict-READY';
  document.getElementById('statsBox').innerHTML = '<div class="stat-row"><span class="l">Place devices and run simulation</span></div>';
  document.getElementById('failBox').innerHTML = '<div style="font-size:11px;color:#4b5563;">No simulation run yet.</div>';
  document.getElementById('iceBar').style.width = '0%';
  document.getElementById('iceBar').textContent = '0%';
  document.getElementById('modeBadge').textContent = 'PLACEMENT MODE';
  document.getElementById('modeBadge').className = 'mode-badge mode-place';
  document.getElementById('mapOverlay').innerHTML = 'Click on the map to <span>place spray devices</span>';
});

// 슬라이더 값 표시 업데이트
document.querySelectorAll('input[type="range"]').forEach(el => {
  el.addEventListener('input', () => {
    document.getElementById('vRange').textContent = `${document.getElementById('sRange').value} m`;
    document.getElementById('vAngle').textContent = `${document.getElementById('sAngle').value}°`;
    document.getElementById('vBurial').textContent = `${document.getElementById('sBurial').value} mm`;
    document.getElementById('vFlow').textContent = `${document.getElementById('sFlow').value} L/min`;
    document.getElementById('vWind').textContent = `${document.getElementById('sWind').value} m/s`;
    if (simRunning) runSimulation();
  });
});

document.getElementById('envPreset').addEventListener('change', () => {
  const e = getEnv();
  document.getElementById('sWind').value = e.wind;
  document.getElementById('vWind').textContent = `${e.wind} m/s`;
  if (simRunning) runSimulation();
});
</script>
</body>
</html>
