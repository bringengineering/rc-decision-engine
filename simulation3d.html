<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>염수분사 시뮬레이션 — 3D + 위성지도</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e1a;color:#e0e0e0;font-family:'Segoe UI',sans-serif;height:100vh;overflow:hidden}

.app{display:grid;grid-template-columns:300px 1fr 320px;grid-template-rows:52px 1fr;height:100vh}

/* Header */
.header{grid-column:1/-1;background:#111827;border-bottom:1px solid #1e293b;display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.header h1{font-size:14px;font-weight:600;color:#60a5fa}
.header-r{display:flex;align-items:center;gap:12px}
.tab-btns{display:flex;gap:2px;background:#1e293b;border-radius:6px;padding:2px}
.tab-btn{padding:5px 16px;border-radius:4px;border:none;background:transparent;color:#94a3b8;font-size:12px;cursor:pointer;font-weight:600;transition:all .15s}
.tab-btn.active{background:#2563eb;color:#fff}
.tab-btn:hover:not(.active){background:#334155}
.mode-badge{padding:3px 10px;border-radius:10px;font-size:10px;font-weight:700;letter-spacing:.5px}
.mode-place{background:#1e40af;color:#93c5fd}
.mode-sim{background:#065f46;color:#6ee7b7}

/* Left Panel */
.panel-l{background:#111827;border-right:1px solid #1e293b;padding:12px;overflow-y:auto;font-size:12px}
.stitle{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:#60a5fa;margin:12px 0 6px;padding-bottom:3px;border-bottom:1px solid #1e293b}
.stitle:first-child{margin-top:0}
.plabel{display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin-top:5px}
.plabel .pv{color:#60a5fa;font-weight:600}
input[type="range"]{width:100%;accent-color:#60a5fa;margin-bottom:1px}
select.c{width:100%;background:#1e293b;color:#e0e0e0;border:1px solid #334155;padding:4px 8px;border-radius:4px;font-size:11px;margin-top:3px}
.btn{padding:6px 14px;border-radius:4px;border:1px solid #334155;background:#1e293b;color:#e0e0e0;font-size:11px;cursor:pointer;transition:all .15s}
.btn:hover{background:#334155}
.btn-p{background:#2563eb;border-color:#3b82f6;color:#fff}
.btn-p:hover{background:#1d4ed8}
.btn-d{background:#991b1b;border-color:#dc2626;color:#fca5a5}
.btn-row{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.info-box{background:#0f172a;border:1px solid #1e293b;border-radius:5px;padding:8px;font-size:10px;color:#94a3b8;line-height:1.6;margin-top:6px}
.info-box strong{color:#60a5fa}
.dev-item{background:#1e293b;border:1px solid #334155;border-radius:5px;padding:6px 8px;margin-bottom:4px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.dev-item .dn{color:#fbbf24;font-weight:600}
.dev-item .dc{color:#64748b}
.dev-item .dx{color:#ef4444;cursor:pointer;padding:1px 5px;border-radius:3px}
.dev-item .dx:hover{background:#450a0a}

/* Center */
.center{position:relative}
#mapView,#view3d{position:absolute;top:0;left:0;width:100%;height:100%}
#view3d{display:none;cursor:crosshair}
#view3d canvas{width:100%!important;height:100%!important}
#mapView{z-index:1}
.crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:100;pointer-events:none;color:#fff;font-size:24px;text-shadow:0 0 4px #000;display:none}
.hud-3d{position:absolute;bottom:12px;left:12px;z-index:100;background:rgba(17,24,39,.88);padding:8px 14px;border-radius:6px;font-size:11px;border:1px solid #1e293b;display:none;line-height:1.7}
.hud-3d .ht{color:#60a5fa;font-weight:600;margin-bottom:2px}
.map-tip{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(17,24,39,.9);padding:5px 14px;border-radius:16px;font-size:11px;color:#94a3b8;border:1px solid #334155;pointer-events:none}
.map-tip span{color:#60a5fa;font-weight:600}

/* Right Panel */
.panel-r{background:#111827;border-left:1px solid #1e293b;padding:12px;overflow-y:auto}
.vbox{text-align:center;padding:12px;border-radius:8px;margin-bottom:12px;font-size:20px;font-weight:800;letter-spacing:2px}
.v-FAIL{background:#450a0a;color:#f87171;border:2px solid #dc2626}
.v-PASS{background:#052e16;color:#4ade80;border:2px solid #16a34a}
.v-COND{background:#422006;color:#fbbf24;border:2px solid #d97706}
.v-READY{background:#1e293b;color:#64748b;border:2px solid #334155}
.sr{display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid #1e293b}
.sr .sl{color:#94a3b8}
.sr .sv{font-weight:600}
.crit{color:#f87171}.warn{color:#fbbf24}.good{color:#4ade80}
.fi{border-left:3px solid #dc2626;padding:6px 8px;margin-bottom:5px;border-radius:0 4px 4px 0;font-size:10px;background:#1e1215}
.fi.fw{border-left-color:#d97706;background:#1e1a0f}
.fi .ftt{font-weight:600;color:#f87171}
.fi.fw .ftt{color:#fbbf24}
.fi .fdd{color:#94a3b8;margin-top:2px}
.rbar{background:#1e293b;border-radius:4px;height:18px;overflow:hidden;margin-top:4px}
.rbar-in{height:100%;background:linear-gradient(90deg,#dc2626,#f87171);transition:width .4s;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff}
.disclaimer{font-size:9px;color:#4b5563;line-height:1.5;margin-top:10px}

/* Search */
.sbox{position:relative;margin-bottom:6px}
.sbox input{width:100%;background:#1e293b;border:1px solid #334155;color:#e0e0e0;padding:6px 8px;border-radius:4px;font-size:11px}
.sbox input::placeholder{color:#4b5563}
.sres{position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid #334155;border-radius:0 0 4px 4px;max-height:180px;overflow-y:auto;z-index:100;display:none}
.sres .si{padding:6px 8px;font-size:11px;cursor:pointer;border-bottom:1px solid #111827}
.sres .si:hover{background:#334155}

.leaflet-container{background:#0f172a}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Brine Spray Simulation — 3D + Satellite</h1>
    <div class="header-r">
      <div class="tab-btns">
        <button class="tab-btn active" id="tabMap" onclick="switchTab('map')">Satellite Map</button>
        <button class="tab-btn" id="tab3d" onclick="switchTab('3d')">3D Walk View</button>
      </div>
      <div class="mode-badge mode-place" id="modeBadge">PLACEMENT</div>
    </div>
  </div>

  <!-- LEFT -->
  <div class="panel-l">
    <div class="stitle">Location</div>
    <div class="sbox">
      <input type="text" id="searchIn" placeholder="Search (e.g. 대관령, 강남역)">
      <div class="sres" id="searchRes"></div>
    </div>
    <select class="c" id="quickLoc">
      <option value="">-- Quick Locations --</option>
      <option value="37.6879,128.7597">Daegwallyeong (대관령)</option>
      <option value="37.5665,126.9780">Seoul City Hall</option>
      <option value="37.2747,127.0094">Suwon IC</option>
      <option value="35.1796,129.0756">Busan Gwangan Bridge</option>
      <option value="37.8813,127.7298">Chuncheon (춘천)</option>
    </select>

    <div class="stitle">Placement</div>
    <div class="info-box">
      <strong>1.</strong> Map: click to place devices<br>
      <strong>2.</strong> 3D View: walk around and inspect<br>
      <strong>3.</strong> Run Simulation for judgment
    </div>

    <div class="stitle">Device Settings</div>
    <label class="plabel">Spray Range <span class="pv" id="vR">8.0m</span></label>
    <input type="range" id="sR" min="2" max="25" value="8" step="0.5">
    <label class="plabel">Spray Angle <span class="pv" id="vA">120°</span></label>
    <input type="range" id="sA" min="30" max="360" value="120" step="10">
    <label class="plabel">Burial Depth <span class="pv" id="vB">400mm</span></label>
    <input type="range" id="sB" min="0" max="1200" value="400" step="50">
    <label class="plabel">Flow Rate <span class="pv" id="vF">5.0 L/min</span></label>
    <input type="range" id="sF" min="1" max="20" value="5" step="0.5">

    <div class="stitle">Environment</div>
    <select class="c" id="envP">
      <option value="gangwon_night">Gangwon Night (-15°C, Snow)</option>
      <option value="seoul_night">Seoul Night (-8°C, Snow)</option>
      <option value="busan_morning">Busan Morning (-2°C, Rain)</option>
      <option value="mild">Mild (-3°C, Light)</option>
    </select>
    <label class="plabel">Wind <span class="pv" id="vW">5.0 m/s</span></label>
    <input type="range" id="sW" min="0" max="15" value="5" step="0.5">

    <div class="stitle">Devices (<span id="dcnt">0</span>)</div>
    <div id="dlist"></div>

    <div class="btn-row">
      <button class="btn btn-p" onclick="runSim()">Run Simulation</button>
      <button class="btn btn-d" onclick="clearAll()">Clear All</button>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div id="mapView">
      <div class="map-tip" id="mapTip">Click map to <span>place spray devices</span></div>
      <div id="map" style="width:100%;height:100%"></div>
    </div>
    <div id="view3d">
      <div class="crosshair" id="crosshair">+</div>
      <div class="hud-3d" id="hud3d">
        <div class="ht">3D Walk Mode</div>
        <div>WASD: Move / Mouse: Look</div>
        <div>Click to lock pointer</div>
        <div id="hudPos"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel-r">
    <div class="stitle">Judgment</div>
    <div class="vbox v-READY" id="vb">READY</div>
    <div class="stitle">Statistics</div>
    <div id="stats"><div class="sr"><span class="sl">Place devices first</span></div></div>
    <div class="stitle">Ice Risk</div>
    <div class="rbar"><div class="rbar-in" id="iceBar" style="width:0%">0%</div></div>
    <div class="stitle" style="margin-top:10px">Failures</div>
    <div id="fails"><div style="font-size:10px;color:#4b5563">No simulation yet</div></div>
    <div class="disclaimer">
      This system provides JUDGMENT INFORMATION only.
      All DECISIONS remain with qualified engineers.
      L0 rule-based simulation.
    </div>
  </div>
</div>

<script>
// ═════════════════════════════════════
//  STATE
// ═════════════════════════════════════
let devices=[], markers=[], overlays=[], devN=0, simActive=false;
let currentTab='map';

const ENVS={
  gangwon_night:{temp:-15,wind:5,wdir:270,hum:75,prec:'snow',cloud:95},
  seoul_night:{temp:-8,wind:3.5,wdir:315,hum:65,prec:'snow',cloud:90},
  busan_morning:{temp:-2,wind:6,wdir:180,hum:80,prec:'freezing_rain',cloud:80},
  mild:{temp:-3,wind:2,wdir:90,hum:55,prec:'snow',cloud:60},
};
const FROST={gangwon:900,seoul:600,busan:300,default:600};

// ═════════════════════════════════════
//  MAP INIT
// ═════════════════════════════════════
const map=L.map('map',{center:[37.6879,128.7597],zoom:17});
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19}).addTo(map);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,opacity:.6}).addTo(map);

map.on('click',e=>{
  devN++;
  const id='SPR-'+String(devN).padStart(3,'0');
  const s=getSet();
  const d={id,lat:e.latlng.lat,lng:e.latlng.lng,...s};
  devices.push(d);
  const mk=L.marker(e.latlng,{icon:L.divIcon({className:'',html:`<svg width="28" height="28"><circle cx="14" cy="14" r="9" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/><circle cx="14" cy="14" r="3" fill="#111"/></svg>`,iconSize:[28,28],iconAnchor:[14,14]}),draggable:true}).addTo(map);
  mk.bindTooltip(id,{permanent:false,direction:'top',offset:[0,-14]});
  mk.on('dragend',ev=>{const p=ev.target.getLatLng();d.lat=p.lat;d.lng=p.lng;if(simActive)runSim();rebuild3D();});
  markers.push(mk);
  updList();
  rebuild3D();
});

// ═════════════════════════════════════
//  SEARCH
// ═════════════════════════════════════
let sto;
const si=document.getElementById('searchIn'),sr=document.getElementById('searchRes');
si.addEventListener('input',()=>{clearTimeout(sto);const q=si.value.trim();if(q.length<2){sr.style.display='none';return;}sto=setTimeout(()=>{fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=kr&limit=5`).then(r=>r.json()).then(d=>{if(!d.length){sr.style.display='none';return;}sr.innerHTML=d.map(x=>`<div class="si" data-lat="${x.lat}" data-lon="${x.lon}">${x.display_name}</div>`).join('');sr.style.display='block';});},400);});
sr.addEventListener('click',e=>{const t=e.target.closest('.si');if(!t)return;map.setView([+t.dataset.lat,+t.dataset.lon],17);sr.style.display='none';si.value=t.textContent;});
document.addEventListener('click',e=>{if(!e.target.closest('.sbox'))sr.style.display='none';});
document.getElementById('quickLoc').addEventListener('change',e=>{if(!e.target.value)return;const[a,b]=e.target.value.split(',').map(Number);map.setView([a,b],17);});

// ═════════════════════════════════════
//  HELPERS
// ═════════════════════════════════════
function getSet(){return{range:+document.getElementById('sR').value,angle:+document.getElementById('sA').value,burial:+document.getElementById('sB').value,flow:+document.getElementById('sF').value};}
function getEnv(){const k=document.getElementById('envP').value;const e={...ENVS[k]};e.wind=+document.getElementById('sW').value;return e;}
function removeDevice(i){devices.splice(i,1);map.removeLayer(markers[i]);markers.splice(i,1);updList();if(simActive)runSim();rebuild3D();}
function updList(){document.getElementById('dcnt').textContent=devices.length;document.getElementById('dlist').innerHTML=devices.map((d,i)=>`<div class="dev-item"><div><span class="dn">${d.id}</span> <span class="dc">${d.lat.toFixed(5)},${d.lng.toFixed(5)}</span></div><span class="dx" onclick="removeDevice(${i})">X</span></div>`).join('');}
function clearAll(){for(const m of markers)map.removeLayer(m);markers=[];devices=[];devN=0;clearOL();simActive=false;updList();document.getElementById('vb').textContent='READY';document.getElementById('vb').className='vbox v-READY';document.getElementById('stats').innerHTML='<div class="sr"><span class="sl">Place devices first</span></div>';document.getElementById('fails').innerHTML='<div style="font-size:10px;color:#4b5563">No sim yet</div>';document.getElementById('iceBar').style.width='0%';document.getElementById('iceBar').textContent='0%';rebuild3D();}
function clearOL(){for(const o of overlays)map.removeLayer(o);overlays=[];}

document.querySelectorAll('input[type="range"]').forEach(el=>el.addEventListener('input',()=>{
  document.getElementById('vR').textContent=document.getElementById('sR').value+'m';
  document.getElementById('vA').textContent=document.getElementById('sA').value+'°';
  document.getElementById('vB').textContent=document.getElementById('sB').value+'mm';
  document.getElementById('vF').textContent=document.getElementById('sF').value+' L/min';
  document.getElementById('vW').textContent=document.getElementById('sW').value+' m/s';
  if(simActive)runSim();
}));
document.getElementById('envP').addEventListener('change',()=>{const e=getEnv();document.getElementById('sW').value=e.wind;document.getElementById('vW').textContent=e.wind+' m/s';if(simActive)runSim();});

// ═════════════════════════════════════
//  SIMULATION
// ═════════════════════════════════════
function runSim(){
  if(!devices.length)return;
  simActive=true;
  document.getElementById('modeBadge').textContent='SIMULATION';
  document.getElementById('modeBadge').className='mode-badge mode-sim';
  clearOL();

  const env=getEnv(), s=getSet();
  let tE=1; if(env.temp<-10)tE=.7;else if(env.temp<-5)tE=.85;else if(env.temp<0)tE=.95;
  const eR=s.range*tE;
  const drift=env.wind*s.range*.05*Math.sin(env.wdir*Math.PI/180);
  let ice=0;const rT=env.temp-2;if(rT<=0){ice+=.4;ice+=Math.min(.3,Math.abs(rT)*.02);}if(env.hum>70)ice+=.1;if(['snow','sleet','freezing_rain'].includes(env.prec))ice+=.2;if(env.wind<2&&env.cloud<30)ice+=.1;ice=Math.min(1,ice);
  const reg=document.getElementById('envP').value.split('_')[0];
  const fD=FROST[reg]||FROST.default;
  const fR=s.burial>0&&s.burial<fD;

  // draw coverage
  for(const d of devices){
    overlays.push(L.circle([d.lat,d.lng],{radius:eR,color:'#3b82f6',fillColor:'#3b82f6',fillOpacity:.25,weight:2,dashArray:'5,5'}).addTo(map));
    overlays.push(L.circle([d.lat,d.lng],{radius:s.range,color:'#60a5fa',fillColor:'#60a5fa',fillOpacity:.07,weight:1,dashArray:'3,6'}).addTo(map));
    if(Math.abs(drift)>.5){const dL=drift*Math.cos(env.wdir*Math.PI/180)/111320;const dN=drift*Math.sin(env.wdir*Math.PI/180)/(111320*Math.cos(d.lat*Math.PI/180));overlays.push(L.polyline([[d.lat,d.lng],[d.lat+dL,d.lng+dN]],{color:'#a855f7',weight:2,dashArray:'4,4'}).addTo(map));}
  }

  // gaps
  let maxGap=0;const fails=[];
  if(devices.length>=2){for(let i=0;i<devices.length;i++)for(let j=i+1;j<devices.length;j++){const dd=map.distance([devices[i].lat,devices[i].lng],[devices[j].lat,devices[j].lng]);const g=dd-eR*2;if(g>maxGap)maxGap=g;if(g>10){const mla=(devices[i].lat+devices[j].lat)/2,mln=(devices[i].lng+devices[j].lng)/2;overlays.push(L.circle([mla,mln],{radius:g/2,color:'#ef4444',fillColor:'#ef4444',fillOpacity:.15,weight:2,dashArray:'6,4'}).addTo(map));const tt=L.tooltip({permanent:true,direction:'center'}).setLatLng([mla,mln]).setContent(`<div style="background:#450a0a;color:#f87171;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;border:1px solid #dc2626">${g.toFixed(0)}m gap</div>`);map.addLayer(tt);overlays.push(tt);}}}

  if(maxGap>10)fails.push({s:'critical',t:`GAP-001 ${maxGap.toFixed(0)}m gap`,d:`Max 10m allowed`});
  else if(maxGap>5)fails.push({s:'warning',t:`GAP-002 ${maxGap.toFixed(0)}m gap`,d:'Near limit'});
  if(Math.abs(drift)>eR*.3)fails.push({s:'warning',t:'WIND-001 Drift',d:`${drift.toFixed(1)}m at ${env.wind}m/s`});
  if(fR)fails.push({s:'critical',t:'FROST-001 Freeze',d:`Burial ${s.burial}mm < frost ${fD}mm`});
  const cr=fails.filter(f=>f.s==='critical').length;
  let v='PASS';if(cr)v='FAIL';else if(fails.length)v='COND';

  // UI
  const vb=document.getElementById('vb');vb.textContent=v==='COND'?'CONDITIONAL PASS':v;vb.className='vbox v-'+v;
  document.getElementById('stats').innerHTML=`
    <div class="sr"><span class="sl">Devices</span><span class="sv">${devices.length}</span></div>
    <div class="sr"><span class="sl">Eff Range</span><span class="sv">${eR.toFixed(1)}m</span></div>
    <div class="sr"><span class="sl">Drift</span><span class="sv ${Math.abs(drift)>1?'warn':''}">${drift.toFixed(1)}m</span></div>
    <div class="sr"><span class="sl">Max Gap</span><span class="sv ${maxGap>10?'crit':maxGap>5?'warn':'good'}">${maxGap.toFixed(1)}m</span></div>
    <div class="sr"><span class="sl">Frost Depth</span><span class="sv">${fD}mm</span></div>
    <div class="sr"><span class="sl">Burial</span><span class="sv ${fR?'crit':'good'}">${s.burial}mm</span></div>
    <div class="sr"><span class="sl">Ice Risk</span><span class="sv ${ice>.7?'crit':ice>.4?'warn':'good'}">${(ice*100).toFixed(0)}%</span></div>
    <div class="sr"><span class="sl">Criticals</span><span class="sv ${cr?'crit':'good'}">${cr}</span></div>`;
  document.getElementById('iceBar').style.width=`${ice*100}%`;document.getElementById('iceBar').textContent=`${(ice*100).toFixed(0)}%`;
  document.getElementById('fails').innerHTML=fails.length?fails.map(f=>`<div class="fi ${f.s==='warning'?'fw':''}"><div class="ftt">${f.t}</div><div class="fdd">${f.d}</div></div>`).join(''):'<div style="font-size:10px;color:#4ade80">No failures</div>';

  rebuild3D();
}

// ═════════════════════════════════════
//  TAB SWITCH
// ═════════════════════════════════════
function switchTab(t){
  currentTab=t;
  document.getElementById('tabMap').classList.toggle('active',t==='map');
  document.getElementById('tab3d').classList.toggle('active',t==='3d');
  document.getElementById('mapView').style.display=t==='map'?'block':'none';
  document.getElementById('view3d').style.display=t==='3d'?'block':'none';
  document.getElementById('crosshair').style.display=t==='3d'?'block':'none';
  document.getElementById('hud3d').style.display=t==='3d'?'block':'none';
  document.getElementById('mapTip').style.display=t==='map'?'block':'none';
  if(t==='3d'){start3D();}
}

// ═════════════════════════════════════
//  THREE.JS 3D
// ═════════════════════════════════════
let scene,camera,renderer,clock;
let moveF=false,moveB=false,moveL=false,moveR=false;
let euler={x:0,y:0};
let initialized3D=false;
let sprayMeshes=[], particleSystems=[];

function init3D(){
  const container=document.getElementById('view3d');
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0a1628);
  scene.fog=new THREE.FogExp2(0x0a1628,.008);

  camera=new THREE.PerspectiveCamera(70,container.clientWidth/container.clientHeight,.1,1000);
  camera.position.set(0,1.7,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(container.clientWidth,container.clientHeight);
  renderer.shadowMap.enabled=true;
  container.appendChild(renderer.domElement);

  clock=new THREE.Clock();

  // 조명
  const amb=new THREE.AmbientLight(0x334466,.6);scene.add(amb);
  const dir=new THREE.DirectionalLight(0x8899bb,.4);dir.position.set(50,80,30);dir.castShadow=true;scene.add(dir);
  const hemi=new THREE.HemisphereLight(0x2244aa,0x111122,.3);scene.add(hemi);

  // 하늘
  const skyGeo=new THREE.SphereGeometry(400,32,32);
  const skyMat=new THREE.MeshBasicMaterial({color:0x0a1628,side:THREE.BackSide});
  scene.add(new THREE.Mesh(skyGeo,skyMat));

  buildRoad();
  buildEnvironment();
  rebuild3DDevices();

  // 눈
  buildSnow();

  // resize
  window.addEventListener('resize',()=>{
    const c=document.getElementById('view3d');
    camera.aspect=c.clientWidth/c.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(c.clientWidth,c.clientHeight);
  });

  initialized3D=true;
}

function buildRoad(){
  // 메인 도로
  const roadGeo=new THREE.PlaneGeometry(12,200);
  const roadMat=new THREE.MeshStandardMaterial({color:0x2a2a2a,roughness:.9});
  const road=new THREE.Mesh(roadGeo,roadMat);
  road.rotation.x=-Math.PI/2;
  road.position.y=0.01;
  road.receiveShadow=true;
  scene.add(road);

  // 차선
  const lineMat=new THREE.MeshBasicMaterial({color:0xddaa33});
  for(let z=-95;z<100;z+=4){
    const lg=new THREE.PlaneGeometry(.15,2);
    const lm=new THREE.Mesh(lg,lineMat);
    lm.rotation.x=-Math.PI/2;
    lm.position.set(0,.02,z);
    scene.add(lm);
  }

  // 도로 경계선 (흰색)
  const wMat=new THREE.MeshBasicMaterial({color:0xcccccc});
  [-6,6].forEach(x=>{
    const lg=new THREE.PlaneGeometry(.15,200);
    const lm=new THREE.Mesh(lg,wMat);
    lm.rotation.x=-Math.PI/2;
    lm.position.set(x,.02,0);
    scene.add(lm);
  });

  // 인도/갓길
  const sidewalkMat=new THREE.MeshStandardMaterial({color:0x3a3a3a,roughness:.95});
  [-8,8].forEach(x=>{
    const sg=new THREE.BoxGeometry(3,.15,200);
    const sm=new THREE.Mesh(sg,sidewalkMat);
    sm.position.set(x,.075,0);
    sm.receiveShadow=true;
    scene.add(sm);
  });

  // 가드레일
  const grMat=new THREE.MeshStandardMaterial({color:0x888888,metalness:.6,roughness:.3});
  [-7,7].forEach(x=>{
    for(let z=-95;z<100;z+=3){
      const pg=new THREE.BoxGeometry(.08,.8,.05);
      const pm=new THREE.Mesh(pg,grMat);
      pm.position.set(x,.4,z);
      scene.add(pm);
    }
    const rg=new THREE.BoxGeometry(.06,.06,200);
    const rm=new THREE.Mesh(rg,grMat);
    rm.position.set(x,.7,0);
    scene.add(rm);
  });

  // 가로등
  const poleMat=new THREE.MeshStandardMaterial({color:0x555555,metalness:.5});
  for(let z=-80;z<=80;z+=40){
    [-9,9].forEach(x=>{
      const pole=new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,6),poleMat);
      pole.position.set(x,3,z);
      scene.add(pole);
      const light=new THREE.PointLight(0xffdd88,.5,20);
      light.position.set(x,6,z);
      scene.add(light);
      const bulb=new THREE.Mesh(new THREE.SphereGeometry(.15),new THREE.MeshBasicMaterial({color:0xffdd88}));
      bulb.position.set(x,6,z);
      scene.add(bulb);
    });
  }

  // 바닥 (도로 주변)
  const groundGeo=new THREE.PlaneGeometry(400,400);
  const groundMat=new THREE.MeshStandardMaterial({color:0x1a2810,roughness:1});
  const ground=new THREE.Mesh(groundGeo,groundMat);
  ground.rotation.x=-Math.PI/2;
  ground.position.y=-0.05;
  ground.receiveShadow=true;
  scene.add(ground);

  // 나무
  const treeMat=new THREE.MeshStandardMaterial({color:0x1a3a10});
  const trunkMat=new THREE.MeshStandardMaterial({color:0x3a2a1a});
  for(let i=0;i<40;i++){
    const x=(Math.random()>.5?1:-1)*(12+Math.random()*30);
    const z=-90+Math.random()*180;
    const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,2),trunkMat);
    trunk.position.set(x,1,z);scene.add(trunk);
    const leaves=new THREE.Mesh(new THREE.ConeGeometry(1.5,4,6),treeMat);
    leaves.position.set(x,4,z);scene.add(leaves);
  }
}

function buildEnvironment(){
  // 산 (원거리 배경)
  const mtnMat=new THREE.MeshStandardMaterial({color:0x1a2a15});
  for(let i=0;i<8;i++){
    const mg=new THREE.ConeGeometry(30+Math.random()*40,20+Math.random()*30,5);
    const mm=new THREE.Mesh(mg,mtnMat);
    const angle=Math.random()*Math.PI*2;
    mm.position.set(Math.cos(angle)*150,0,Math.sin(angle)*150);
    scene.add(mm);
  }
}

function buildSnow(){
  const count=3000;
  const geo=new THREE.BufferGeometry();
  const pos=new Float32Array(count*3);
  for(let i=0;i<count;i++){
    pos[i*3]=Math.random()*200-100;
    pos[i*3+1]=Math.random()*50;
    pos[i*3+2]=Math.random()*200-100;
  }
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const mat=new THREE.PointsMaterial({color:0xffffff,size:.15,transparent:true,opacity:.8});
  const snow=new THREE.Points(geo,mat);
  snow.userData.isSnow=true;
  scene.add(snow);
}

function rebuild3DDevices(){
  // 기존 장치 제거
  for(const m of sprayMeshes)scene.remove(m);
  sprayMeshes=[];
  for(const p of particleSystems)scene.remove(p);
  particleSystems=[];

  if(!devices.length)return;

  // 장치들의 중심 계산
  const cLat=devices.reduce((s,d)=>s+d.lat,0)/devices.length;
  const cLng=devices.reduce((s,d)=>s+d.lng,0)/devices.length;

  const s=getSet();

  devices.forEach((d,i)=>{
    // 위경도 → 로컬 좌표 (m)
    const dx=(d.lng-cLng)*111320*Math.cos(cLat*Math.PI/180);
    const dz=-(d.lat-cLat)*111320;

    // 장치 본체 (노면 설치 장치)
    const base=new THREE.Group();

    // 매립 플레이트
    const plateMat=new THREE.MeshStandardMaterial({color:0xccaa33,metalness:.7,roughness:.3});
    const plate=new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.05,16),plateMat);
    plate.position.y=.03;
    base.add(plate);

    // 노즐
    const nozzleMat=new THREE.MeshStandardMaterial({color:0x888888,metalness:.8,roughness:.2});
    const nozzle=new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,.15,8),nozzleMat);
    nozzle.position.y=.12;
    base.add(nozzle);

    // 라벨 (ID)
    // (텍스트는 sprite로)
    const canvas2=document.createElement('canvas');
    canvas2.width=128;canvas2.height=64;
    const c2=canvas2.getContext('2d');
    c2.fillStyle='rgba(17,24,39,0.8)';
    c2.fillRect(0,0,128,64);
    c2.fillStyle='#fbbf24';
    c2.font='bold 20px monospace';
    c2.textAlign='center';
    c2.fillText(d.id,64,38);
    const tex=new THREE.CanvasTexture(canvas2);
    const spriteMat=new THREE.SpriteMaterial({map:tex,transparent:true});
    const sprite=new THREE.Sprite(spriteMat);
    sprite.scale.set(1.5,.75,1);
    sprite.position.y=1.5;
    base.add(sprite);

    base.position.set(dx,0,dz);
    scene.add(base);
    sprayMeshes.push(base);

    // 분사 파티클
    const pCount=500;
    const pGeo=new THREE.BufferGeometry();
    const pPos=new Float32Array(pCount*3);
    const pCol=new Float32Array(pCount*3);
    for(let j=0;j<pCount;j++){
      const angle=Math.random()*Math.PI*2;
      const r=Math.random()*s.range;
      const h=Math.random()*.4;
      pPos[j*3]=dx+Math.cos(angle)*r;
      pPos[j*3+1]=h;
      pPos[j*3+2]=dz+Math.sin(angle)*r;
      pCol[j*3]=.2+Math.random()*.3;
      pCol[j*3+1]=.5+Math.random()*.3;
      pCol[j*3+2]=.9;
    }
    pGeo.setAttribute('position',new THREE.BufferAttribute(pPos,3));
    pGeo.setAttribute('color',new THREE.BufferAttribute(pCol,3));
    const pMat=new THREE.PointsMaterial({size:.08,vertexColors:true,transparent:true,opacity:.6});
    const particles=new THREE.Points(pGeo,pMat);
    particles.userData.deviceIndex=i;
    particles.userData.cx=dx;
    particles.userData.cz=dz;
    particles.userData.range=s.range;
    scene.add(particles);
    particleSystems.push(particles);

    // 커버리지 범위 원 (바닥)
    const circGeo=new THREE.RingGeometry(s.range-.1,s.range,32);
    const circMat=new THREE.MeshBasicMaterial({color:0x3b82f6,transparent:true,opacity:.5,side:THREE.DoubleSide});
    const circ=new THREE.Mesh(circGeo,circMat);
    circ.rotation.x=-Math.PI/2;
    circ.position.set(dx,.03,dz);
    scene.add(circ);
    sprayMeshes.push(circ);

    // 커버리지 바닥 원 (채우기)
    const fillGeo=new THREE.CircleGeometry(s.range,32);
    const fillMat=new THREE.MeshBasicMaterial({color:0x3b82f6,transparent:true,opacity:.1,side:THREE.DoubleSide});
    const fill=new THREE.Mesh(fillGeo,fillMat);
    fill.rotation.x=-Math.PI/2;
    fill.position.set(dx,.02,dz);
    scene.add(fill);
    sprayMeshes.push(fill);
  });

  // 카메라를 첫 번째 장치 근처에
  if(devices.length){
    const d0=devices[0];
    const cLat2=devices.reduce((s,d)=>s+d.lat,0)/devices.length;
    const cLng2=devices.reduce((s,d)=>s+d.lng,0)/devices.length;
    const dx=(d0.lng-cLng2)*111320*Math.cos(cLat2*Math.PI/180);
    const dz=-(d0.lat-cLat2)*111320;
    camera.position.set(dx-5,1.7,dz+10);
    euler.y=Math.atan2(5,-10);
  }
}

function rebuild3D(){
  if(!initialized3D)return;
  rebuild3DDevices();
}

function start3D(){
  if(!initialized3D)init3D();
  else{rebuild3DDevices();}
  animate3D();
}

function animate3D(){
  if(currentTab!=='3d')return;
  requestAnimationFrame(animate3D);

  const dt=clock.getDelta();
  const speed=5*dt;

  // 이동
  const dir=new THREE.Vector3();
  camera.getWorldDirection(dir);
  dir.y=0;dir.normalize();
  const right=new THREE.Vector3();right.crossVectors(dir,new THREE.Vector3(0,1,0));

  if(moveF)camera.position.addScaledVector(dir,speed);
  if(moveB)camera.position.addScaledVector(dir,-speed);
  if(moveL)camera.position.addScaledVector(right,-speed);
  if(moveR)camera.position.addScaledVector(right,speed);
  camera.position.y=1.7;

  // 카메라 회전 적용
  camera.rotation.order='YXZ';
  camera.rotation.y=euler.y;
  camera.rotation.x=euler.x;

  // 눈 애니메이션
  scene.traverse(obj=>{
    if(obj.userData.isSnow){
      const pos=obj.geometry.attributes.position;
      for(let i=0;i<pos.count;i++){
        pos.array[i*3+1]-=dt*2;
        pos.array[i*3]+=dt*.3;
        if(pos.array[i*3+1]<0){pos.array[i*3+1]=40;pos.array[i*3]=Math.random()*200-100;}
      }
      pos.needsUpdate=true;
    }
  });

  // 분사 파티클 애니메이션
  for(const ps of particleSystems){
    const pos=ps.geometry.attributes.position;
    const cx=ps.userData.cx,cz=ps.userData.cz,range=ps.userData.range;
    for(let i=0;i<pos.count;i++){
      pos.array[i*3+1]-=dt*.5;
      if(pos.array[i*3+1]<0){
        const a=Math.random()*Math.PI*2;
        const r=Math.random()*range;
        pos.array[i*3]=cx+Math.cos(a)*r;
        pos.array[i*3+1]=Math.random()*.3+.1;
        pos.array[i*3+2]=cz+Math.sin(a)*r;
      }
    }
    pos.needsUpdate=true;
  }

  // HUD
  document.getElementById('hudPos').textContent=`Pos: ${camera.position.x.toFixed(1)}, ${camera.position.z.toFixed(1)}`;

  renderer.render(scene,camera);
}

// ═════════════════════════════════════
//  CONTROLS
// ═════════════════════════════════════
document.addEventListener('keydown',e=>{
  if(currentTab!=='3d')return;
  if(e.key==='w'||e.key==='W'||e.key==='ArrowUp')moveF=true;
  if(e.key==='s'||e.key==='S'||e.key==='ArrowDown')moveB=true;
  if(e.key==='a'||e.key==='A'||e.key==='ArrowLeft')moveL=true;
  if(e.key==='d'||e.key==='D'||e.key==='ArrowRight')moveR=true;
});
document.addEventListener('keyup',e=>{
  if(e.key==='w'||e.key==='W'||e.key==='ArrowUp')moveF=false;
  if(e.key==='s'||e.key==='S'||e.key==='ArrowDown')moveB=false;
  if(e.key==='a'||e.key==='A'||e.key==='ArrowLeft')moveL=false;
  if(e.key==='d'||e.key==='D'||e.key==='ArrowRight')moveR=false;
});

document.getElementById('view3d').addEventListener('click',function(){
  this.requestPointerLock();
});
document.addEventListener('pointerlockchange',()=>{});
document.addEventListener('mousemove',e=>{
  if(document.pointerLockElement!==document.getElementById('view3d'))return;
  euler.y-=e.movementX*.002;
  euler.x-=e.movementY*.002;
  euler.x=Math.max(-Math.PI/2.5,Math.min(Math.PI/2.5,euler.x));
});
</script>
</body>
</html>
